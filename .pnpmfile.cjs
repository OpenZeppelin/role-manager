/**
 * pnpm hook for local development with @openzeppelin/ui-* packages
 *
 * This file enables seamless local development by dynamically resolving
 * @openzeppelin/ui-* packages to local file paths when LOCAL_UI=true.
 *
 * Usage:
 *   LOCAL_UI=true pnpm install   # Use local packages
 *   pnpm install                  # Use npm packages (default)
 *
 * Or use the convenience scripts:
 *   pnpm dev:local               # Enable local packages
 *   pnpm dev:npm                 # Switch to npm packages
 *
 * Generated by: openzeppelin-ui/scripts/setup-local-dev.mjs
 * Extended for: role-manager (includes UI Builder adapters)
 */

const path = require('path');

// Resolve paths relative to this pnpmfile (monorepo root)
const MONOREPO_ROOT = __dirname;

// Path to openzeppelin-ui repo (core UI packages)
const LOCAL_UI_PATH = path.resolve(
  MONOREPO_ROOT,
  process.env.LOCAL_UI_PATH || '../openzeppelin-ui'
);

// Path to contracts-ui-builder repo (adapter packages)
const LOCAL_UI_BUILDER_PATH = path.resolve(
  MONOREPO_ROOT,
  process.env.LOCAL_UI_BUILDER_PATH || '../contracts-ui-builder'
);

/**
 * Maps npm package names to their directory paths within openzeppelin-ui
 */
const UI_PACKAGE_MAP = {
  '@openzeppelin/ui-types': 'packages/types',
  '@openzeppelin/ui-utils': 'packages/utils',
  '@openzeppelin/ui-styles': 'packages/styles',
  '@openzeppelin/ui-components': 'packages/components',
  '@openzeppelin/ui-renderer': 'packages/renderer',
  '@openzeppelin/ui-react': 'packages/react',
  '@openzeppelin/ui-storage': 'packages/storage',
};

/**
 * Maps npm package names to their directory paths within contracts-ui-builder
 * These adapter packages remain in the UI Builder repo
 */
const UI_BUILDER_PACKAGE_MAP = {
  '@openzeppelin/ui-builder-adapter-evm': 'packages/adapter-evm',
  '@openzeppelin/ui-builder-adapter-stellar': 'packages/adapter-stellar',
  '@openzeppelin/ui-builder-adapter-solana': 'packages/adapter-solana',
};

/**
 * Hook called by pnpm for each package being resolved
 * @param {object} pkg - The package.json content
 * @param {object} context - Context with directory info and logging
 * @returns {object} - Modified package.json content
 */
function readPackage(pkg, context) {
  // Skip if local development is not enabled
  if (process.env.LOCAL_UI !== 'true') {
    return pkg;
  }

  // Replace dependencies with local file: references
  for (const depType of ['dependencies', 'devDependencies', 'peerDependencies']) {
    if (!pkg[depType]) continue;

    // Handle @openzeppelin/ui-* packages from openzeppelin-ui
    for (const [npmName, localPath] of Object.entries(UI_PACKAGE_MAP)) {
      if (pkg[depType][npmName]) {
        const absolutePath = path.join(LOCAL_UI_PATH, localPath);
        pkg[depType][npmName] = `file:${absolutePath}`;
        context.log(`[local-dev] ${npmName} → ${absolutePath}`);
      }
    }

    // Handle @openzeppelin/ui-builder-adapter-* packages from contracts-ui-builder
    for (const [npmName, localPath] of Object.entries(UI_BUILDER_PACKAGE_MAP)) {
      if (pkg[depType][npmName]) {
        const absolutePath = path.join(LOCAL_UI_BUILDER_PATH, localPath);
        pkg[depType][npmName] = `file:${absolutePath}`;
        context.log(`[local-dev] ${npmName} → ${absolutePath}`);
      }
    }
  }

  return pkg;
}

module.exports = {
  hooks: {
    readPackage,
  },
};
