#!/usr/bin/env bash

echo "ğŸ” Running pre-commit checks..."

# Try to use NVM's Node.js if available
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  # Load NVM
  export NVM_DIR="$HOME/.nvm"
  \. "$NVM_DIR/nvm.sh" # This loads nvm
  
  # Use Node.js 20+
  nvm use 20 >/dev/null 2>&1
  
  echo "âœ… Using Node.js $(node -v) from NVM"
fi

# Require Node.js 20+ as specified in package.json
node_version=$(node -v | cut -d. -f1 | sed 's/v//')
if [ "$node_version" -lt 20 ]; then
  echo "âŒ Error: Node.js version $(node -v) is incompatible. This project requires Node.js 20.19.0+."
  echo "âŒ Commit aborted. Please use Node.js 20+ for development."
  exit 1
fi

# Early commit message validation (when using git commit -m "message")
# This allows failing fast before running expensive lint/format operations
if [ -f ".git/COMMIT_EDITMSG" ]; then
  echo "ğŸ“ Validating commit message format (early check)..."
  if ! npx --no -- commitlint --edit .git/COMMIT_EDITMSG 2>/dev/null; then
    echo ""
    echo "âŒ Commit message format is invalid!"
    echo ""
    echo "ğŸ“‹ Allowed scopes: role-manager, components, hooks, deps, config, ci, docs, tests, release, ui, utils, types"
    echo "ğŸ“‹ Allowed types: build, chore, ci, docs, feat, fix, perf, refactor, revert, style, test, wip"
    echo ""
    echo "Example: feat(role-manager): add new feature"
    echo ""
    exit 1
  fi
  echo "âœ… Commit message format is valid"
fi

# Check if there are any staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACMR)
if [ -z "$staged_files" ]; then
  echo "â„¹ï¸ No files staged for commit, skipping checks."
  exit 0
fi

# Run formatting and linting on staged files
echo "ğŸ¨ Running formatting and linting..."
pnpm fix-all
