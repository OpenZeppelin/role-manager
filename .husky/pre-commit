#!/usr/bin/env bash

echo "üîç Running pre-commit checks..."

# Try to use NVM's Node.js if available
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  # Load NVM
  export NVM_DIR="$HOME/.nvm"
  \. "$NVM_DIR/nvm.sh" # This loads nvm
  
  # Use Node.js 20+
  nvm use 20 >/dev/null 2>&1
  
  echo "‚úÖ Using Node.js $(node -v) from NVM"
fi

# Require Node.js 20+ as specified in package.json
node_version=$(node -v | cut -d. -f1 | sed 's/v//')
if [ "$node_version" -lt 20 ]; then
  echo "‚ùå Error: Node.js version $(node -v) is incompatible. This project requires Node.js 20.19.0+."
  echo "‚ùå Commit aborted. Please use Node.js 20+ for development."
  exit 1
fi

# Check if there are any staged files
staged_files=$(git diff --cached --name-only --diff-filter=ACMR)
if [ -z "$staged_files" ]; then
  echo "‚ÑπÔ∏è No files staged for commit, skipping checks."
  exit 0
fi

# Note: Commit message validation happens in prepare-commit-msg hook
# Due to git's hook order, the commit message isn't available in pre-commit when using `-m` flag
# prepare-commit-msg runs after pre-commit but will fail fast to prevent commit completion

# Check for local tarball dependencies in package.json
# We want to prevent committing local file paths that won't work in CI
# Only check if package.json is among the staged files
if echo "$staged_files" | grep -q "apps/role-manager/package.json"; then
  if grep -q "file:.*contracts-ui-builder" apps/role-manager/package.json; then
    echo ""
    echo "‚ùå Error: Local tarball dependencies detected in package.json!"
    echo "   These paths (file:...) will fail in CI/production."
    echo ""
    echo "   üëâ Run 'pnpm dev:registry' to switch to registry versions."
    echo ""
    exit 1
  fi
fi

# Run formatting and linting on staged files (expensive operations last)
echo "üé® Running formatting and linting..."
pnpm fix-all
